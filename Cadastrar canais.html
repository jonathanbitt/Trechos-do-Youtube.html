<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Cadastro de V√≠deo com Trechos</title>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<style>
  body { font-family: Arial, sans-serif; margin: 15px; background: #f5f5f5; }
  h2 { text-align: center; }
  input, textarea, select, button {
    display: block; margin-bottom: 12px; width: 100%;
    padding: 12px; font-size: 16px; border-radius: 8px;
    border: 1px solid #ccc; box-sizing: border-box;
  }
  textarea { min-height: 70px; resize: vertical; }
  fieldset {
    margin-bottom: 20px; padding: 15px; background: #fff;
    border-radius: 8px; border: 1px solid #ddd;
  }
  legend { font-weight: bold; }
  button { background: #007BFF; color: white; border: none; cursor: pointer; }
  button:hover { background: #0056b3; }
  .add-btn { background: #28a745; }
  .add-btn:hover { background: #1e7e34; }
</style>
</head>
<body>

<h2>Cadastro de V√≠deo com Trechos</h2>

<!-- Sele√ß√£o de idioma e canal existentes -->
<label>Escolher Idioma</label>
<select id="idiomaSelect">
  <option value="">-- Selecione um idioma --</option>
  <option value="pt">Portugu√™s</option>
  <option value="en">Ingl√™s</option>
  <option value="fr">Franc√™s</option>
  <option value="it">Italiano</option>
</select>

<label>Escolher Canal</label>
<select id="canalSelect">
  <option value="">-- Selecione um canal --</option>
</select>

<!-- CAMPOS PARA T√çTULO E ID DO V√çDEO -->
<label>T√≠tulo do V√≠deo</label>
<input type="text" id="videoTitle" placeholder="Digite o t√≠tulo do v√≠deo" required>

<label>ID do V√≠deo (YouTube)</label>
<input type="text" id="videoId" placeholder="Digite o ID do v√≠deo do YouTube" required>

<hr>

<form id="videoForm">
  <label>Dados do V√≠deo (preenchimento autom√°tico)</label>
  <input type="text" id="mainData" placeholder="Canal;T√≠tulo;VideoID;Idioma" readonly style="background-color: #f0f0f0;">

  <label>Idioma do V√≠deo</label>
  <select id="languageSelect" required>
    <option value="">Selecione um idioma</option>
    <option value="pt">Portugu√™s</option>
    <option value="en">Ingl√™s</option>
    <option value="fr">Franc√™s</option>
    <option value="it">Italiano</option>
  </select>

  <h3>Transcri√ß√£o Completa do V√≠deo</h3>
  <div id="segmentsContainer">
    <!-- √önico campo de transcri√ß√£o -->
    <fieldset>
      <legend>Transcri√ß√£o</legend>
      <label>Digite toda a transcri√ß√£o do v√≠deo:</label>
      <textarea name="transcription" placeholder="Cole aqui toda a transcri√ß√£o do v√≠deo..." style="min-height: 200px;"></textarea>
    </fieldset>
  </div>

  <button type="submit">üíæ Salvar no Firestore</button>
</form>

<script>
  // --- Firebase ---
  const firebaseConfig = {
    apiKey: "SUA_API_KEY",
    authDomain: "trechos-c7fba.firebaseapp.com",
    projectId: "trechos-c7fba",
    storageBucket: "trechos-c7fba.appspot.com",
    messagingSenderId: "334052038527",
    appId: "SEU_APP_ID"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // --- Fun√ß√£o para determinar o nome da cole√ß√£o do idioma ---
  function getCollectionNameByLanguage(language) {
    const languageCollections = {
      'pt': 'canaisportugues',
      'en': 'canaisingles', 
      'fr': 'canaisfrances',
      'it': 'canaisitaliano'
    };
    return languageCollections[language] || 'canais';
  }

  // --- Fun√ß√£o para atualizar o campo mainData automaticamente ---
  function atualizarMainData() {
    const canal = document.getElementById('canalSelect').value;
    const titulo = document.getElementById('videoTitle').value;
    const videoId = document.getElementById('videoId').value;
    const idioma = document.getElementById('idiomaSelect').value;
    
    if (canal && titulo && videoId && idioma) {
      document.getElementById('mainData').value = `${canal};${titulo};${videoId};${idioma}`;
      document.getElementById('languageSelect').value = idioma;
    }
  }

  // --- Fun√ß√£o para dividir a transcri√ß√£o em segmentos ---
  function dividirTranscricao(transcricaoCompleta) {
    if (!transcricaoCompleta.trim()) return [];
    
    // Divide a transcri√ß√£o por linhas ou por pontos para criar segmentos
    const linhas = transcricaoCompleta.split('\n').filter(linha => linha.trim() !== '');
    const segmentos = [];
    
    linhas.forEach((linha, index) => {
      if (linha.trim()) {
        segmentos.push({
          title: `Parte ${index + 1}`,
          transcription: linha.trim()
        });
      }
    });
    
    // Se n√£o houve divis√£o por linhas, divide por senten√ßas
    if (segmentos.length === 0 && transcricaoCompleta.length > 200) {
      const sentencas = transcricaoCompleta.split(/[.!?]+/).filter(s => s.trim());
      sentencas.forEach((sentenca, index) => {
        if (sentenca.trim()) {
          segmentos.push({
            title: `Parte ${index + 1}`,
            transcription: sentenca.trim() + '.'
          });
        }
      });
    }
    
    // Se ainda n√£o h√° segmentos, cria um √∫nico segmento
    if (segmentos.length === 0) {
      segmentos.push({
        title: 'Transcri√ß√£o completa',
        transcription: transcricaoCompleta.trim()
      });
    }
    
    return segmentos;
  }

  // --- Salvar no Firestore ---
  document.getElementById("videoForm").addEventListener("submit", async function(e) {
    e.preventDefault();

    const mainData = document.getElementById("mainData").value.trim().split(";");
    if(mainData.length < 4 || !mainData[0] || !mainData[1] || !mainData[2] || !mainData[3]) {
      alert("‚ö†Ô∏è Preencha todos os campos: Canal, T√≠tulo, VideoID e Idioma");
      return;
    }

    const canal = mainData[0].trim();
    const videoTitle = mainData[1].trim();
    const videoId = mainData[2].trim();
    const idiomaMain = mainData[3].trim();
    const language = document.getElementById("languageSelect").value;

    // Verificar se o idioma do select combina com o do mainData
    if(language && idiomaMain && language !== idiomaMain) {
      alert("‚ö†Ô∏è O idioma no campo principal deve ser igual ao selecionado no dropdown");
      return;
    }

    const idiomaFinal = language || idiomaMain;

    if(!idiomaFinal) {
      alert("‚ö†Ô∏è Selecione um idioma para o v√≠deo");
      return;
    }

    // Obter a transcri√ß√£o completa
    const transcriptionElement = document.querySelector('[name="transcription"]');
    const transcricaoCompleta = transcriptionElement ? transcriptionElement.value.trim() : '';

    if (!transcricaoCompleta) {
      alert("‚ö†Ô∏è Digite a transcri√ß√£o do v√≠deo");
      return;
    }

    // Dividir a transcri√ß√£o em segmentos automaticamente
    const segments = dividirTranscricao(transcricaoCompleta);

    try {
      // 1Ô∏è‚É£ Salvar na cole√ß√£o do canal (estrutura original)
      const videoRef = db.collection(canal).doc(videoTitle);
      
      // Ler segmentos existentes (para preservar se quiser adicionar mais depois)
      const docSnap = await videoRef.get();
      let existingSegments = [];
      if(docSnap.exists && Array.isArray(docSnap.data().segments)) {
        existingSegments = docSnap.data().segments;
      }

      // Concatenar novos trechos sem apagar os antigos (ou substituir completamente)
      const updatedSegments = segments; // Para substituir completamente, use apenas segments

      // Salvar v√≠deo com idioma na cole√ß√£o do canal
      await videoRef.set({ 
        videoId, 
        language: idiomaFinal, 
        segments: updatedSegments,
        title: videoTitle,
        lastUpdated: new Date().toISOString(),
        transcricaoCompleta: transcricaoCompleta // Salvar tamb√©m a vers√£o completa
      }, { merge: true });

      // 2Ô∏è‚É£ Salvar tamb√©m na cole√ß√£o do idioma correspondente
      const collectionIdioma = getCollectionNameByLanguage(idiomaFinal);
      const canalRefIdioma = db.collection(collectionIdioma).doc(canal);
      
      await canalRefIdioma.set({
        nomeExibicao: canal,
        idioma: idiomaFinal,
        ultimaAtualizacao: new Date().toISOString()
      }, { merge: true });

      // 3Ô∏è‚É£ Garantir que canal exista na cole√ß√£o "canasmusicas" (para compatibilidade)
      await db.collection("canasmusicas").doc(canal).set({ 
        exists: true,
        lastUpdated: new Date().toISOString()
      }, { merge: true });

      alert(`‚úÖ V√≠deo "${videoTitle}" salvo com sucesso!\n\nSalvo em:\n- Cole√ß√£o: ${canal}\n- Cole√ß√£o de idioma: ${collectionIdioma}\n- Segmentos criados: ${segments.length}`);
      
      // Limpar formul√°rio ap√≥s salvar
      document.getElementById("mainData").value = "";
      document.getElementById("videoTitle").value = "";
      document.getElementById("videoId").value = "";
      document.getElementById("languageSelect").value = "";
      document.getElementById("idiomaSelect").value = "";
      document.getElementById("canalSelect").value = "";
      transcriptionElement.value = "";
    } catch(err) {
      console.error("Erro ao salvar:", err);
      alert("‚ùå Erro ao salvar: " + err.message);
    }
  });

  // --- Carregar canais baseado no idioma selecionado ---
  async function carregarCanaisPorIdioma(idioma) {
    const canalSelect = document.getElementById("canalSelect");
    canalSelect.innerHTML = '<option value="">-- Selecione um canal --</option>';
    canalSelect.disabled = true;
    
    if(!idioma) return;

    try {
      const collectionIdioma = getCollectionNameByLanguage(idioma);
      const snapshot = await db.collection(collectionIdioma).get();
      
      if(snapshot.empty) {
        canalSelect.innerHTML = '<option value="">Nenhum canal encontrado para este idioma</option>';
        return;
      }

      snapshot.forEach(doc => {
        const option = document.createElement("option");
        option.value = doc.id;
        option.textContent = doc.data().nomeExibicao || doc.id;
        canalSelect.appendChild(option);
      });
      
      canalSelect.disabled = false;
    } catch(err) {
      console.error("Erro ao carregar canais por idioma:", err);
      canalSelect.innerHTML = '<option value="">Erro ao carregar canais</option>';
    }
  }

  // --- Event listeners para atualiza√ß√£o autom√°tica do mainData ---
  document.getElementById("canalSelect").addEventListener("change", atualizarMainData);
  document.getElementById("videoTitle").addEventListener("input", atualizarMainData);
  document.getElementById("videoId").addEventListener("input", atualizarMainData);
  document.getElementById("idiomaSelect").addEventListener("change", atualizarMainData);

  // --- Ao selecionar idioma, carregar canais ---
  document.getElementById("idiomaSelect").addEventListener("change", function() {
    const idioma = this.value;
    carregarCanaisPorIdioma(idioma);
    
    // Sincronizar com o select de idioma do formul√°rio
    document.getElementById("languageSelect").value = idioma;
    atualizarMainData();
  });

  // --- Sincronizar o select de idioma com os dados ---
  document.getElementById("languageSelect").addEventListener("change", function() {
    const idioma = this.value;
    document.getElementById("idiomaSelect").value = idioma;
    carregarCanaisPorIdioma(idioma);
    atualizarMainData();
  });
</script>

</body>
</html>