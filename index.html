<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Segmentos do Vídeo</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 900px; margin: auto; padding: 20px; background: #f7f7f7; }
    h1 { text-align: center; }
    #player { display: block; margin: 0 auto 20px auto; box-shadow: 0 0 10px rgba(0,0,0,0.2); }
    .seg { background: white; border-radius: 5px; padding: 10px 15px; margin-bottom: 8px; box-shadow: 0 0 5px rgba(0,0,0,0.1); cursor: pointer; user-select: none; }
    .seg h3 { margin: 0; font-weight: normal; color: #007BFF; }
    .seg h3:hover { text-decoration: underline; }
    .details { margin-top: 10px; padding-top: 10px; border-top: 1px solid #ddd; }
    .times { color: #666; font-size: 0.9em; margin-bottom: 8px; }
    button { margin-right: 8px; cursor: pointer; padding: 5px 10px; border: none; border-radius: 3px; background-color: #007BFF; color: white; font-size: 0.9em; transition: background-color 0.2s ease; user-select: none; }
    button:hover { background-color: #0056b3; }
    textarea { width: 100%; box-sizing: border-box; margin-top: 6px; margin-bottom: 10px; padding: 6px; font-size: 0.9em; border: 1px solid #ccc; border-radius: 3px; resize: vertical; }
    .transcript { background-color: #f8f9fa; border-left: 4px solid #007BFF; padding: 10px; margin: 10px 0 5px 0; font-size: 0.9em; line-height: 1.5; white-space: pre-line; }
    .translation { background-color: #fff3cd; border-left: 4px solid #ffc107; padding: 10px; margin: 5px 0 10px 0; font-size: 0.9em; line-height: 1.5; white-space: pre-line; }
    .toggle-transcript, .toggle-translation { background-color: #6c757d; font-size: 0.8em; margin-right: 5px; padding: 3px 6px; border-radius: 3px; }
    .toggle-transcript:hover, .toggle-translation:hover { background-color: #5a6268; }
    #loading { text-align: center; padding: 20px; font-style: italic; color: #666; }
    #backBtn { margin-bottom: 20px; background-color: #28a745; }
    #backBtn:hover { background-color: #1e7e34; }
    #saveNotesBtn { background-color: #17a2b8; margin-top: 4px; }
    #saveNotesBtn:hover { background-color: #117a8b; }
    #statusMsg { margin-top: 8px; font-size: 0.9em; color: green; font-weight: bold; }
  </style>
</head>
<body>

<h1 id="videoTitle">Carregando título do vídeo...</h1>

<div id="player"></div>

<div id="controls">
  <button id="pauseBtn">Pausar</button>
  <button id="stopBtn">Parar</button>
  <div id="play-status">parado</div>
</div>

<div id="loading">Carregando segmentos do vídeo...</div>
<div id="segments-container"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCNgDqkqhsFQY7bfrWK2_VPtGUoEyyIBq4",
    authDomain: "trechos-c7fba.firebaseapp.com",
    projectId: "trechos-c7fba",
    storageBucket: "trechos-c7fba.appspot.com",
    messagingSenderId: "334052038527",
    appId: "1:334052038527:web:797e8967eaef7b198a2c4a",
    measurementId: "G-FL2Q1KLJMT"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Pega o ID do documento pela URL: ?id=<docId>
  const params = new URLSearchParams(window.location.search);
  const docId = params.get("id") || "dailyRoutine"; // default

  let player, currentSegment = null, checkInterval = null, segments = [];
  const container = document.getElementById('segments-container');
  const loadingEl = document.getElementById('loading');
  const videoTitleEl = document.getElementById('videoTitle');

  const toSeconds = t => {
    const p = t.split(':').map(Number);
    return p.length === 2 ? p[0]*60 + p[1] : p[0]*3600 + p[1]*60 + p[2];
  };

  const updateStatus = txt => document.getElementById('play-status').textContent = txt;

  function loadVideoData() {
    db.collection("videos_temp").doc(docId).get()
      .then(doc => {
        if(!doc.exists){
          loadingEl.textContent = "Documento não encontrado.";
          return;
        }
        const data = doc.data();
        videoTitleEl.textContent = data.titulodovideo || "Vídeo sem título";
        segments = data.segments || [];
        renderTitles();
        loadingEl.style.display = 'none';

        if(player && data.videoId){
          player.loadVideoById(data.videoId);
        }
      })
      .catch(err => {
        console.error("Erro ao carregar vídeo:", err);
        loadingEl.textContent = "Erro ao carregar dados.";
      });
  }

  function renderTitles() {
    container.innerHTML = '';
    segments.forEach((seg, i) => {
      const div = document.createElement('div');
      div.className = 'seg';
      div.innerHTML = `<h3 data-index="${i}">${i+1}. ${seg.title}</h3>`;
      container.appendChild(div);
    });
    setupTitleClicks();
  }

  function renderSegmentDetails(seg, index) {
    container.innerHTML = '';
    const div = document.createElement('div');
    div.className = 'seg';
    div.innerHTML = `
      <button id="backBtn">← Voltar à lista</button>
      <h3>${seg.title}</h3>
      <div class="details">
        <div class="times">⏱️ ${seg.start} – ${seg.end}</div>
        <button class="playBtn" data-index="${index}">▶️ Tocar</button>
        <button class="toggle-transcript" data-index="${index}">Mostrar Transcrição</button>
        <button class="toggle-translation" data-index="${index}">Mostrar Tradução</button>
        <div class="transcript" data-index="${index}" style="display:none">${seg.transcription || 'Nenhuma transcrição disponível'}</div>
        <div class="translation" data-index="${index}" style="display:none">${seg.translation || 'Nenhuma tradução disponível'}</div>
        <textarea id="notesArea" placeholder="Digite suas observações aqui..." rows="4">${seg.notes || ''}</textarea>
        <button id="saveNotesBtn">Salvar Anotações</button>
        <div id="statusMsg"></div>
      </div>
    `;
    container.appendChild(div);

    document.getElementById('backBtn').onclick = () => { renderTitles(); document.getElementById('statusMsg').textContent = ''; };
    document.querySelector('.playBtn').onclick = e => { playSegment(segments[e.target.dataset.index]); };
    document.querySelector('.toggle-transcript').onclick = e => {
      const el = document.querySelector(`.transcript[data-index="${e.target.dataset.index}"]`);
      const show = el.style.display === 'none';
      el.style.display = show ? 'block' : 'none';
      e.target.textContent = show ? 'Ocultar Transcrição' : 'Mostrar Transcrição';
    };
    document.querySelector('.toggle-translation').onclick = e => {
      const el = document.querySelector(`.translation[data-index="${e.target.dataset.index}"]`);
      const show = el.style.display === 'none';
      el.style.display = show ? 'block' : 'none';
      e.target.textContent = show ? 'Ocultar Tradução' : 'Mostrar Tradução';
    };
    document.getElementById('saveNotesBtn').onclick = async () => {
      const text = document.getElementById('notesArea').value.trim();
      const statusMsg = document.getElementById('statusMsg');
      statusMsg.style.color = 'green';
      statusMsg.textContent = 'Salvando...';
      try {
        segments[e.target.dataset.index].notes = text;
        await db.collection("videos_temp").doc(docId).update({ segments });
        statusMsg.textContent = 'Anotações salvas com sucesso!';
      } catch (err) {
        console.error("Erro ao salvar anotações:", err);
        statusMsg.style.color = 'red';
        statusMsg.textContent = 'Erro ao salvar anotações.';
      }
    };
  }

  function setupTitleClicks() {
    const titles = document.querySelectorAll('.seg h3');
    titles.forEach(title => {
      title.onclick = () => renderSegmentDetails(segments[title.dataset.index], title.dataset.index);
    });
  }

  function playSegment(seg) {
    if(!player) return;
    currentSegment = { start: toSeconds(seg.start), end: toSeconds(seg.end) };
    player.seekTo(currentSegment.start);
    player.unMute();
    player.playVideo();
    updateStatus(`Tocando: ${seg.title}`);
    clearInterval(checkInterval);
    checkInterval = setInterval(() => {
      if(player.getCurrentTime() >= currentSegment.end){
        player.pauseVideo();
        updateStatus(`Trecho concluído: ${seg.title}`);
        clearInterval(checkInterval);
        currentSegment = null;
      }
    }, 300);
  }

  function stopPlayer() { player.stopVideo(); updateStatus('Vídeo parado'); clearInterval(checkInterval); currentSegment=null; }

  // YouTube API
  window.onYouTubeIframeAPIReady = function(){
    player = new YT.Player('player',{
      height:'360', width:'640',
      videoId:'', // carregado dinamicamente
      playerVars:{ modestbranding:1, rel:0, controls:1, enablejsapi:1, origin:window.location.origin, playsinline:1 },
      events:{
        onReady: loadVideoData,
        onStateChange:e=>{
          if(e.data==YT.PlayerState.PLAYING) updateStatus('Tocando');
          if(e.data==YT.PlayerState.PAUSED) updateStatus('Pausado');
          if(e.data==YT.PlayerState.ENDED){ updateStatus('Vídeo terminado'); clearInterval(checkInterval); currentSegment=null; }
        }
      }
    });
  };

  document.getElementById('pauseBtn').onclick = () => player.pauseVideo();
  document.getElementById('stopBtn').onclick = stopPlayer;

  const tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  document.body.appendChild(tag);
</script>
</body>
</html>
