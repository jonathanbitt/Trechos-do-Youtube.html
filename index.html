<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Segmentos do V√≠deo - Acorde√£o Animado</title>
<style>
body { font-family: Arial,sans-serif; max-width:900px; margin:auto; padding:20px; background:#f7f7f7;}
h1{text-align:center;}
#player{display:block;margin:0 auto 20px auto;box-shadow:0 0 10px rgba(0,0,0,0.2);}
.seg{background:white;border-radius:5px;padding:10px;margin-bottom:5px;box-shadow:0 0 3px rgba(0,0,0,0.1);}
.seg.completed{background-color:#d4edda;}
.seg h3{margin:0; cursor:pointer; user-select:none;}
.details{overflow:hidden; max-height:0; transition:max-height 0.3s ease, padding 0.3s ease;}
.details.open{max-height:2000px; padding-top:8px;}
.times{color:#666;font-size:0.9em;margin-bottom:8px;}
button{margin:4px 4px 8px 0;cursor:pointer;padding:6px 10px;border:none;border-radius:3px;background-color:#007BFF;color:white;font-size:0.9em;}
button:hover{background-color:#0056b3;}
button.markBtn{background-color:#28a745;}
button.markBtn:hover{background-color:#1e7e34;}
button.saveCommentBtn{background-color:#17a2b8; margin-bottom: 10px;}
button.saveCommentBtn:hover{background-color:#138496;}
textarea,input.tagsInput{width:100%;margin-top:6px;margin-bottom:10px;padding:6px;font-size:0.9em;border:1px solid #ccc;border-radius:3px;}
.transcript,.translation{padding:10px;margin:10px 0;font-size:0.9em;line-height:1.5;white-space:pre-line;}
.transcript a.time-link{color:#007BFF; text-decoration:none; cursor:pointer;}
.transcript a.time-link:hover{ text-decoration:underline; }
.transcript{background-color:#f8f9fa;border-left:4px solid #007BFF; display:block;}
.translation{background-color:#fff3cd;border-left:4px solid #ffc107; display:block;}
.toggle-transcript,.toggle-translation{background-color:#6c757d;font-size:0.8em;}
.toggle-transcript:hover,.toggle-translation:hover{background-color:#5a6268;}
#controls{text-align:center;margin-bottom:20px;}
#play-status{margin-top:10px;font-weight:bold;text-align:center;min-height:1.2em;}
#loading{text-align:center;padding:20px;font-style:italic;color:#666;}
</style>
</head>
<body>

<h1>Trechos do V√≠deo</h1>

<div style="text-align:center; margin-bottom:15px;">
  <input type="text" id="docName" placeholder="Digite o nome do documento (ex: ItalianoConAmore1)" style="width:70%; padding:8px;">
  <button id="loadDocBtn">Carregar</button>
</div>

<div id="player"></div>
<div id="controls">
  <button id="pauseBtn">‚è∏ Pausar</button>
  <button id="stopBtn">‚èπ Parar</button>
  <div id="play-status">parado</div>
</div>

<div id="loading">Informe o documento para carregar os segmentos...</div>
<div id="segments-container"></div>

<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
<script>
const firebaseConfig = {
  apiKey: "AIzaSyCNgDqkqhsFQY7bfrWK2_VPtGUoEyyIBq4",
  authDomain: "trechos-c7fba.firebaseapp.com",
  projectId: "trechos-c7fba",
  storageBucket: "trechos-c7fba.appspot.com",
  messagingSenderId: "334052038527",
  appId: "1:334052038527:web:797e8967eaef7b198a2c4a",
  measurementId: "G-FL2Q1KLJMT"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

let player, currentSegment=null, checkInterval=null, segments=[], videoId='', currentDocName='';
const container = document.getElementById('segments-container');
const loadingEl = document.getElementById('loading');

const toSeconds = t => { const p = t.split(':').map(Number); return p.length===2?p[0]*60+p[1]:p[0]*3600+p[1]*60+p[2];};
const updateStatus = txt => document.getElementById('play-status').textContent=txt;
const saveState = (id,state,docName)=>{const k='segments_'+docName; const all=JSON.parse(localStorage.getItem(k)||'{}'); all[id]={...all[id],...state}; localStorage.setItem(k,JSON.stringify(all));};
const loadState=(id,docName)=>JSON.parse(localStorage.getItem('segments_'+docName)||'{}')[id]||{};

function makeTranscriptLinks(text){
  return text.replace(/\((\d{1,2}:\d{2})\)/g, (match,p1)=>{
    const seconds = toSeconds(p1);
    return `<a href="#" class="time-link" data-time="${seconds}">(${p1})</a>`;
  });
}

async function saveCommentToFirebase(segmentIndex, comment, docName) {
  if (!docName) return;
  try {
    const docRef = db.collection('videos_temp').doc(docName);
    // Primeiro obtemos o documento atual para preservar os outros campos
    const doc = await docRef.get();
    const currentData = doc.data();
    const updatedSegments = [...currentData.segments];
    
    // Atualiza apenas o campo observacoes do segmento espec√≠fico
    updatedSegments[segmentIndex] = {
      ...updatedSegments[segmentIndex],
      observacoes: comment
    };
    
    // Atualiza o documento completo com os segmentos modificados
    await docRef.update({
      segments: updatedSegments
    });
    
    // Atualiza o localStorage tamb√©m para manter a sincronia
    saveState(segments[segmentIndex].start+'_'+segmentIndex, {comment: comment}, docName);
    alert('Coment√°rio salvo com sucesso no Firebase!');
  } catch (err) {
    console.error("Erro ao salvar coment√°rio no Firebase:", err);
    alert('Erro ao salvar coment√°rio. Tente novamente.');
  }
}

async function loadSegments(docName){
  currentDocName = docName;
  loadingEl.textContent="Carregando segmentos...";
  container.innerHTML='';
  try{
    const docSnap=await db.collection('videos_temp').doc(docName).get();
    if(!docSnap.exists){loadingEl.textContent="Documento n√£o encontrado."; return;}
    const data = docSnap.data();
    videoId = data.videoId;
    segments = data.segments || [];
    if(!segments.length){loadingEl.textContent="Nenhum segmento encontrado."; return;}
    if(!player) createPlayer(videoId, ()=>renderSegments(docName));
    else{ player.loadVideoById(videoId); renderSegments(docName); }
  }catch(err){console.error(err); loadingEl.textContent="Erro ao carregar.";}
}

function renderSegments(docName){
  loadingEl.style.display='none'; container.innerHTML='';
  segments.forEach((seg,i)=>{
    const st=loadState(seg.start+'_'+i,docName);
    const div=document.createElement('div');
    div.className='seg'+(st.completed?' completed':'');
    div.innerHTML=`
      <h3 data-id="${i}">${seg.title || ''}</h3>
      <div class="details">
        <div class="times">‚è±Ô∏è ${seg.start} ‚Äì ${seg.end}</div>
        <button class="playBtn" data-id="${i}">‚ñ∂Ô∏è Tocar</button>
        <button class="markBtn" data-id="${i}">${st.completed?'Desmarcar':'Conclu√≠do'}</button>
        <button class="toggle-transcript" data-id="${i}">Mostrar Transcri√ß√£o</button>
        <button class="toggle-translation" data-id="${i}">Mostrar Tradu√ß√£o</button>
        <div class="transcript" data-id="${i}">${seg.transcription ? makeTranscriptLinks(seg.transcription) : 'Nenhuma transcri√ß√£o'}</div>
        <div class="translation" data-id="${i}">${seg.translation||'Nenhuma tradu√ß√£o'}</div>
        <textarea class="commentBox" data-id="${i}" rows="2" placeholder="Coment√°rios...">${st.comment||seg.observacoes||''}</textarea>
        <button class="saveCommentBtn" data-id="${i}">üíæ Salvar Coment√°rio</button>
        <input class="tagsInput" data-id="${i}" type="text" placeholder="Tags" value="${st.tags||''}">
      </div>
    `;
    container.appendChild(div);
  });
  setupEvents(docName,true);
}

function setupEvents(docName,isAccordion=false){
  const addEvents=(el,fn)=>{el.addEventListener('click',fn); el.addEventListener('touchstart',fn);};

  addEvents(document.getElementById('pauseBtn'),()=>player.pauseVideo());
  addEvents(document.getElementById('stopBtn'),stopPlayer);

  if(isAccordion){
    container.querySelectorAll('.seg h3').forEach(title=>{
      addEvents(title,()=>{
        container.querySelectorAll('.details').forEach(d=>{if(d!==title.nextElementSibling)d.classList.remove('open');});
        const detail=title.nextElementSibling;
        detail.classList.toggle('open');
      });
    });
  }

  container.querySelectorAll('.playBtn').forEach(btn=>addEvents(btn,()=>{
    const seg=segments[btn.dataset.id]; if(seg) playSegment(seg);
  }));

  container.querySelectorAll('.markBtn').forEach(btn=>addEvents(btn,()=>{
    const div=btn.closest('.seg'); const done=div.classList.toggle('completed'); btn.textContent=done?'Desmarcar':'Conclu√≠do';
    saveState(btn.dataset.id,{completed:done},docName);
  }));

  container.querySelectorAll('.toggle-transcript').forEach(btn=>addEvents(btn,()=>{
    const el=document.querySelector(`.transcript[data-id="${btn.dataset.id}"]`);
    el.style.display=el.style.display==='block'?'none':'block';
    btn.textContent=el.style.display==='block'?'Ocultar Transcri√ß√£o':'Mostrar Transcri√ß√£o';
  }));

  container.querySelectorAll('.toggle-translation').forEach(btn=>addEvents(btn,()=>{
    const el=document.querySelector(`.translation[data-id="${btn.dataset.id}"]`);
    el.style.display=el.style.display==='block'?'none':'block';
    btn.textContent=el.style.display==='block'?'Ocultar Tradu√ß√£o':'Mostrar Tradu√ß√£o';
  }));

  container.querySelectorAll('.commentBox').forEach(txt=>{
    txt.oninput=e=>saveState(e.target.dataset.id,{comment:e.target.value},docName);
  });
  
  container.querySelectorAll('.tagsInput').forEach(inp=>inp.oninput=e=>saveState(e.target.dataset.id,{tags:e.target.value},docName));

  container.querySelectorAll('.saveCommentBtn').forEach(btn=>{
    btn.addEventListener('click',()=>{
      const commentBox = document.querySelector(`.commentBox[data-id="${btn.dataset.id}"]`);
      const comment = commentBox.value;
      saveCommentToFirebase(parseInt(btn.dataset.id), comment, docName);
    });
  });

  container.addEventListener('click', e => {
    if(e.target.classList.contains('time-link')){
      e.preventDefault();
      const t = Number(e.target.dataset.time);
      if(player){ player.seekTo(t); player.playVideo(); }
    }
  });
}

function playSegment(seg){
  if(!player)return;
  currentSegment={start:toSeconds(seg.start),end:toSeconds(seg.end)};
  player.seekTo(currentSegment.start); player.playVideo();
  updateStatus(`Tocando: ${seg.title}`);
  clearInterval(checkInterval);
  checkInterval=setInterval(()=>{
    if(player.getCurrentTime()>=currentSegment.end){
      player.pauseVideo(); updateStatus(`Trecho conclu√≠do: ${seg.title}`);
      clearInterval(checkInterval); currentSegment=null;
    }
  },300);
}

function stopPlayer(){player.stopVideo(); updateStatus('V√≠deo parado'); clearInterval(checkInterval); currentSegment=null;}

function createPlayer(videoId,onReadyFn){
  player=new YT.Player('player',{height:'360',width:'640',videoId:videoId,
  playerVars:{modestbranding:1,rel:0,controls:1,playsinline:1},
  events:{onReady:onReadyFn,onStateChange:e=>{if(e.data==YT.PlayerState.PLAYING)updateStatus('Tocando');if(e.data==YT.PlayerState.PAUSED)updateStatus('Pausado');}}});
}

document.getElementById('loadDocBtn').onclick=()=>{const name=document.getElementById('docName').value.trim();if(name)loadSegments(name);};
const params=new URLSearchParams(location.search);
if(params.has('doc')){document.getElementById('docName').value=params.get('doc'); loadSegments(params.get('doc'));}
const tag=document.createElement('script'); tag.src="https://www.youtube.com/iframe_api"; document.body.appendChild(tag);
</script>
</body>
</html>