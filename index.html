<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <title>Segmentos do Vídeo - Daily Routine</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      max-width: 900px;
      margin: auto;
      padding: 20px;
      background: #f7f7f7;
    }
    h1 { text-align: center; }
    #player {
      display: block;
      margin: 0 auto 20px auto;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .seg {
      background: white;
      border-radius: 5px;
      padding: 10px 15px;
      margin-bottom: 8px;
      box-shadow: 0 0 5px rgba(0,0,0,0.1);
      cursor: pointer;
      user-select: none;
    }
    .seg h3 {
      margin: 0;
      font-weight: normal;
      color: #007BFF;
    }
    .seg h3:hover { text-decoration: underline; }
    .details {
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid #ddd;
    }
    .times {
      color: #666;
      font-size: 0.9em;
      margin-bottom: 8px;
    }
    button {
      margin-right: 8px;
      cursor: pointer;
      padding: 5px 10px;
      border: none;
      border-radius: 3px;
      background-color: #007BFF;
      color: white;
      font-size: 0.9em;
      transition: background-color 0.2s ease;
      user-select: none;
    }
    button:hover { background-color: #0056b3; }
    textarea {
      width: 100%;
      box-sizing: border-box;
      margin-top: 6px;
      margin-bottom: 10px;
      padding: 6px;
      font-size: 0.9em;
      border: 1px solid #ccc;
      border-radius: 3px;
      resize: vertical;
    }
    .transcript {
      background-color: #f8f9fa;
      border-left: 4px solid #007BFF;
      padding: 10px;
      margin: 10px 0 5px 0;
      font-size: 0.9em;
      line-height: 1.5;
      white-space: pre-line;
    }
    .translation {
      background-color: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 10px;
      margin: 5px 0 10px 0;
      font-size: 0.9em;
      line-height: 1.5;
      white-space: pre-line;
    }
    .toggle-transcript, .toggle-translation {
      background-color: #6c757d;
      font-size: 0.8em;
      margin-right: 5px;
      padding: 3px 6px;
      border-radius: 3px;
    }
    .toggle-transcript:hover, .toggle-translation:hover { background-color: #5a6268; }
    #loading {
      text-align: center;
      padding: 20px;
      font-style: italic;
      color: #666;
    }
    #backBtn {
      margin-bottom: 20px;
      background-color: #28a745;
    }
    #backBtn:hover { background-color: #1e7e34; }
    #saveNotesBtn {
      background-color: #17a2b8;
      margin-top: 4px;
    }
    #saveNotesBtn:hover { background-color: #117a8b; }
    #statusMsg {
      margin-top: 8px;
      font-size: 0.9em;
      color: green;
      font-weight: bold;
    }
  </style>
</head>
<body>

<h1>Trechos do Vídeo: Daily Routine</h1>

<div id="player" allow="autoplay; encrypted-media" playsinline></div>

<div id="controls">
  <button id="pauseBtn">Pausar</button>
  <button id="stopBtn">Parar</button>
  <div id="play-status">parado</div>
</div>

<div id="loading">Carregando segmentos do vídeo...</div>
<div id="segments-container"></div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyCNgDqkqhsFQY7bfrWK2_VPtGUoEyyIBq4",
    authDomain: "trechos-c7fba.firebaseapp.com",
    projectId: "trechos-c7fba",
    storageBucket: "trechos-c7fba.appspot.com",
    messagingSenderId: "334052038527",
    appId: "1:334052038527:web:797e8967eaef7b198a2c4a",
    measurementId: "G-FL2Q1KLJMT"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  const collectionName = "Learn How To Talk About Your Daily Routine in English by Watching Me Act Out Mine";
  const segmentsRef = db.collection(collectionName);

  let player, currentSegment = null, checkInterval = null, segments = [];
  const container = document.getElementById('segments-container');
  const loadingEl = document.getElementById('loading');

  const toSeconds = t => {
    const p = t.split(':').map(Number);
    return p.length === 2 ? p[0]*60 + p[1] : p[0]*3600 + p[1]*60 + p[2];
  };

  const updateStatus = txt => document.getElementById('play-status').textContent = txt;

  function loadSegments() {
    segmentsRef.orderBy("start").get()
      .then(q => {
        segments = q.docs.map(doc => ({ id: doc.id, ...doc.data() }));
        renderTitles();
        loadingEl.style.display = 'none';
      })
      .catch(err => {
        console.error("Erro ao carregar segmentos: ", err);
        loadingEl.textContent = "Erro ao carregar os segmentos.";
      });
  }

  function renderTitles() {
    container.innerHTML = '';
    segments.forEach((seg, i) => {
      const div = document.createElement('div');
      div.className = 'seg';
      div.innerHTML = `<h3 data-id="${seg.id}">${i+1}. ${seg.title}</h3>`;
      container.appendChild(div);
    });
    setupTitleClicks();
  }

  function renderSegmentDetails(seg) {
    container.innerHTML = '';
    const div = document.createElement('div');
    div.className = 'seg';
    div.innerHTML = `
      <button id="backBtn">← Voltar à lista</button>
      <h3>${seg.title}</h3>
      <div class="details">
        <div class="times">⏱️ ${seg.start} – ${seg.end}</div>
        <button class="playBtn" data-id="${seg.id}">▶️ Tocar</button>
        <button class="toggle-transcript" data-id="${seg.id}">Mostrar Transcrição</button>
        <button class="toggle-translation" data-id="${seg.id}">Mostrar Tradução</button>
        <div class="transcript" data-id="${seg.id}" style="display:none">${seg.transcript || 'Nenhuma transcrição disponível'}</div>
        <div class="translation" data-id="${seg.id}" style="display:none">${seg.translation || 'Nenhuma tradução disponível'}</div>
        <textarea id="notesArea" placeholder="Digite suas observações aqui..." rows="4">${seg.observacoes || ''}</textarea>
        <button id="saveNotesBtn">Salvar Anotações</button>
        <div id="statusMsg"></div>
      </div>
    `;
    container.appendChild(div);
    setupDetailEvents(seg);
    document.getElementById('backBtn').onclick = () => {
      renderTitles();
      document.getElementById('statusMsg').textContent = '';
    };
  }

  function setupTitleClicks() {
    const titles = document.querySelectorAll('.seg h3');
    titles.forEach(title => {
      title.onclick = () => {
        const id = title.dataset.id;
        const seg = segments.find(s => s.id === id);
        if (seg) renderSegmentDetails(seg);
      };
    });
  }

  function setupDetailEvents(seg) {
    // Play direto no clique para evitar bloqueio no mobile
    document.querySelector('.playBtn').onclick = e => {
      const segToPlay = segments.find(s => s.id === seg.id);
      if (segToPlay && player && player.playVideo) {
        currentSegment = { start: toSeconds(segToPlay.start), end: toSeconds(segToPlay.end) };
        player.seekTo(currentSegment.start, true);
        player.unMute();
        player.playVideo(); // CHAMADA DIRETA
        updateStatus(`Tocando: ${segToPlay.title}`);

        clearInterval(checkInterval);
        checkInterval = setInterval(() => {
          if (player.getCurrentTime() >= currentSegment.end) {
            player.pauseVideo();
            updateStatus(`Trecho concluído: ${segToPlay.title}`);
            clearInterval(checkInterval);
            currentSegment = null;
          }
        }, 300);
      }
      e.stopPropagation();
    };

    document.querySelector('.toggle-transcript').onclick = e => {
      const el = document.querySelector(`.transcript[data-id="${seg.id}"]`);
      const show = el.style.display === 'none';
      el.style.display = show ? 'block' : 'none';
      e.target.textContent = show ? 'Ocultar Transcrição' : 'Mostrar Transcrição';
      e.stopPropagation();
    };

    document.querySelector('.toggle-translation').onclick = e => {
      const el = document.querySelector(`.translation[data-id="${seg.id}"]`);
      const show = el.style.display === 'none';
      el.style.display = show ? 'block' : 'none';
      e.target.textContent = show ? 'Ocultar Tradução' : 'Mostrar Tradução';
      e.stopPropagation();
    };

    document.getElementById('saveNotesBtn').onclick = async () => {
      const text = document.getElementById('notesArea').value.trim();
      const statusMsg = document.getElementById('statusMsg');
      statusMsg.style.color = 'green';
      statusMsg.textContent = 'Salvando...';
      try {
        await segmentsRef.doc(seg.id).update({ observacoes: text });
        const index = segments.findIndex(s => s.id === seg.id);
        if(index !== -1) segments[index].observacoes = text;
        statusMsg.textContent = 'Anotações salvas com sucesso!';
      } catch (err) {
        console.error("Erro ao salvar anotações:", err);
        statusMsg.style.color = 'red';
        statusMsg.textContent = 'Erro ao salvar anotações.';
      }
    };
  }

  function stopPlayer() {
    player.stopVideo();
    updateStatus('Vídeo parado');
    clearInterval(checkInterval);
    currentSegment = null;
  }

  window.onYouTubeIframeAPIReady = function() {
    player = new YT.Player('player', {
      height: '360',
      width: '640',
      videoId: 'ecF1y2bI2T4',
      playerVars: {
        modestbranding: 1,
        rel: 0,
        controls: 1,
        playsinline: 1
      },
      events: {
        onReady: loadSegments,
        onStateChange: e => {
          if (e.data == YT.PlayerState.PLAYING) updateStatus('Tocando');
          if (e.data == YT.PlayerState.PAUSED) updateStatus('Pausado');
          if (e.data == YT.PlayerState.ENDED) {
            updateStatus('Vídeo terminado');
            clearInterval(checkInterval);
            currentSegment = null;
          }
        }
      }
    });
  };

  const tag = document.createElement('script');
  tag.src = "https://www.youtube.com/iframe_api";
  document.body.appendChild(tag);
</script>

</body>
</html>
