<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Visualizador de V√≠deos por Canal</title>
<style>
body { font-family: Arial,sans-serif; max-width:1000px; margin:auto; padding:20px; background:#f7f7f7; line-height:1.6; }
h1 { text-align:center; color:#333; margin-bottom:20px; }
.section { background:white; border-radius:8px; padding:15px; margin-bottom:20px; box-shadow:0 2px 5px rgba(0,0,0,0.1);}
select, button { padding:10px; margin:5px; border-radius:4px; border:1px solid #ddd; font-size:1em; }
button { background-color:#007BFF; color:white; cursor:pointer; border:none; transition:background-color 0.3s; }
button:hover { background-color:#0056b3; }
button:disabled { background-color:#cccccc; cursor:not-allowed; }
#player-container { display:flex; justify-content:center; margin:20px 0; }
#player { width:100%; max-width:640px; height:360px; box-shadow:0 0 10px rgba(0,0,0,0.2);}
#controls { text-align:center; margin-bottom:20px; }
#play-status { margin-top:10px; font-weight:bold; text-align:center; min-height:1.2em; color:#333; }
.loading { text-align:center; padding:20px; font-style:italic; color:#666; }
.error { text-align:center; padding:20px; color:#dc3545; background-color:#f8d7da; border-radius:5px; }
.part { background:white; border-radius:5px; padding:15px; margin-bottom:15px; box-shadow:0 2px 4px rgba(0,0,0,0.05);}
.part-title { font-size:1.2em; font-weight:bold; margin-bottom:10px; padding-bottom:8px; border-bottom:1px solid #eee; color:#444; }
.segment { background:#f9f9f9; border-radius:5px; padding:10px; margin-bottom:8px; }
.segment-header { display:flex; justify-content:space-between; align-items:center; cursor:pointer; user-select:none; }
.segment-title { font-weight:bold; margin:0; flex-grow:1; }
.segment-times { color:#666; font-size:0.9em; margin-right:10px; }
.segment-details { max-height:0; overflow:hidden; transition:max-height 0.3s ease; }
.segment-details.open { max-height:1000px; }
.transcription { margin-top:10px; padding:10px; background:#f0f0f0; border-radius:4px; white-space:pre-line; }
.play-segment-btn { background-color:#28a745; margin-top:8px; }
.play-segment-btn:hover { background-color:#1e7e34; }
#linkBtn { position:absolute; display:none; z-index:9999; padding:8px 12px; border-radius:20px; font-size:14px; background:#343a40; color:#fff; box-shadow:0 4px 14px rgba(0,0,0,0.25); border:none; cursor:pointer; }
#linkBtn:hover { background:#23272b; }
#linkBtn:active { transform:scale(0.98); }
#linkModal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%, -50%); background:white; padding:20px; border-radius:8px; box-shadow:0 5px 25px rgba(0,0,0,0.3); z-index:10000; width:90%; max-width:500px; }
#linkModal h3 { margin-top:0; color:#333; }
#linkModal input { width:100%; padding:10px; margin-bottom:15px; border:1px solid #ddd; border-radius:4px; font-size:1em; }
#modalOverlay { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; }
a.time-link { color:#007BFF; text-decoration:underline; cursor:pointer; }
</style>
</head>
<body>
<h1>Visualizador de V√≠deos por Canal</h1>

<div class="section">
    <h2>Selecionar V√≠deo</h2>
    <div>
        <select id="channelSelect"><option value="">Selecione um canal</option></select>
        <select id="videoSelect" disabled><option value="">Selecione um v√≠deo</option></select>
        <button id="loadBtn" disabled>Carregar V√≠deo</button>
    </div>
</div>

<div id="player-container"><div id="player"></div></div>

<div id="controls">
    <button id="pauseBtn" disabled>‚è∏ Pausar</button>
    <button id="stopBtn" disabled>‚èπ Parar</button>
    <div id="play-status">Parado</div>
</div>

<div id="content">
    <div id="loading" class="loading">Selecione um v√≠deo para carregar os segmentos...</div>
    <div id="error" class="error" style="display:none;"></div>
    <div id="parts-container"></div>
</div>

<!-- Bot√£o flutuante e modal -->
<button id="linkBtn">üìé Criar Link</button>
<div id="modalOverlay"></div>
<div id="linkModal">
    <h3>Criar Link</h3>
    <input type="text" id="wordInputLink" placeholder="Palavra" readonly>
    <input type="text" id="urlInput" placeholder="URL do link">
    <div>
        <button id="saveLinkBtn">Salvar</button>
        <button id="cancelLinkBtn" style="background-color:#6c757d;">Cancelar</button>
    </div>
</div>

<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>

<div style="text-align:center; margin:30px 0;">
    <button id="cadastrarVideoBtn" style="padding:12px 20px; font-size:16px; background:#17a2b8; color:white; border:none; border-radius:5px; cursor:pointer;">
        Cadastrar V√≠deo
    </button>
</div>


<script>
// Config Firebase
const firebaseConfig = {
    apiKey: "AIzaSyCNgDqkqhsFQY7bfrWK2_VPtGUoEyyIBq4",
    authDomain: "trechos-c7fba.firebaseapp.com",
    projectId: "trechos-c7fba",
    storageBucket: "trechos-c7fba.appspot.com",
    messagingSenderId: "334052038527",
    appId: "1:334052038527:web:797e8967eaef7b198a2c4a",
    measurementId: "G-FL2Q1KLJMT"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();

// Vari√°veis globais
let player, currentVideoData=null, currentSegment=null, checkInterval=null, currentVideoId='';
let selectedWord='', selectedRange=null;

// DOM
const channelSelect = document.getElementById('channelSelect');
const videoSelect = document.getElementById('videoSelect');
const loadBtn = document.getElementById('loadBtn');
const pauseBtn = document.getElementById('pauseBtn');
const stopBtn = document.getElementById('stopBtn');
const playStatus = document.getElementById('play-status');
const loadingEl = document.getElementById('loading');
const errorEl = document.getElementById('error');
const partsContainer = document.getElementById('parts-container');

const linkBtn = document.getElementById('linkBtn');
const linkModal = document.getElementById('linkModal');
const modalOverlay = document.getElementById('modalOverlay');
const wordInputLink = document.getElementById('wordInputLink');
const urlInput = document.getElementById('urlInput');
const saveLinkBtn = document.getElementById('saveLinkBtn');
const cancelLinkBtn = document.getElementById('cancelLinkBtn');

// Util
const toSeconds = (timeStr)=>{
    const parts=timeStr.split(':').map(Number);
    if(parts.length===2) return parts[0]*60+parts[1];
    if(parts.length===3) return parts[0]*3600+parts[1]*60+parts[2];
    return 0;
};


function makeTranscriptLinks(text){
    return text.replace(/\((\d{1,2}:\d{2}(?::\d{2})?)\)/g, (match,p1)=>{
        const seconds = toSeconds(p1);
        return `<a href="javascript:void(0)" class="time-link" data-time="${seconds}">(${p1})</a>`;
    });
}


const updateStatus=text=>playStatus.textContent=text;

function showLoading(msg){ loadingEl.textContent=msg; loadingEl.style.display='block'; partsContainer.style.display='none'; }
function hideLoading(){ loadingEl.style.display='none'; partsContainer.style.display='block'; }
function showError(msg){ errorEl.textContent=msg; errorEl.style.display='block'; }
function hideError(){ errorEl.style.display='none'; }


// Listener para links de tempo (0:00, 0:01, etc.)
document.addEventListener('click', function(e) {
    if (e.target.classList.contains('time-link')) {
        e.preventDefault(); // evita o "#" padr√£o
        const t = Number(e.target.dataset.time);
        if (player) {
            player.seekTo(t, true); // ir para o tempo exato
            player.playVideo();
        }
    }
});

// Carregar canais
async function loadChannels(){
    try{
        loadingEl.textContent="Carregando canais...";
        const snap=await db.collection('canais').get();
        channelSelect.innerHTML='<option value="">Selecione um canal</option>';
        snap.forEach(doc=>{
            const opt=document.createElement('option');
            opt.value=doc.id; opt.textContent=doc.id;
            channelSelect.appendChild(opt);
        });
        loadingEl.textContent="Selecione um canal para carregar os v√≠deos...";
    }catch(e){ showError("Erro ao carregar canais"); console.error(e);}
}

// Carregar v√≠deos de um canal
async function loadVideosFromChannel(channelId){
    videoSelect.disabled=true; loadBtn.disabled=true; videoSelect.innerHTML='<option value="">Selecione um v√≠deo</option>';
    try{
        const snap=await db.collection(channelId).get();
        if(snap.empty){ videoSelect.innerHTML='<option value="">Nenhum v√≠deo encontrado</option>'; return; }
        snap.forEach(doc=>{
            const opt=document.createElement('option');
            opt.value=doc.id; opt.textContent=doc.data().title||doc.id;
            videoSelect.appendChild(opt);
        });
        videoSelect.disabled=false;
    }catch(e){ showError("Erro ao carregar v√≠deos"); console.error(e);}
}

// Carregar dados do v√≠deo
async function loadVideoData(channelId,videoId){
    showLoading("Carregando partes do v√≠deo..."); partsContainer.innerHTML=''; hideError();
    try{
        const docSnap=await db.collection(channelId).doc(videoId).get();
        if(!docSnap.exists){ showLoading("Nenhum dado encontrado"); return; }
        currentVideoData=docSnap.data(); hideLoading(); renderVideoParts();
        if(currentVideoData.videoId) loadYouTubePlayer(currentVideoData.videoId);
    }catch(e){ showError("Erro ao carregar dados do v√≠deo"); console.error(e);}
}

async function renderVideoParts() {
    partsContainer.innerHTML = '';
    if(!currentVideoData || !currentVideoData.segments || currentVideoData.segments.length === 0){
        const div = document.createElement('div'); div.className = 'part'; div.textContent = 'Nenhum segmento encontrado'; partsContainer.appendChild(div); 
        return;
    }

    // Buscar todos os links salvos no Firebase
    const linksSnap = await db.collection('links').get();
    const linksMap = {};
    linksSnap.forEach(doc => {
        linksMap[doc.data().palavra] = doc.data().link;
    });

    const partsMap = {};
    currentVideoData.segments.forEach((seg,i)=>{
        let partName = "Parte 1";
        if(seg.title && seg.title.includes("Parte")){
            const m = seg.title.match(/Parte\s*\d+/i); if(m) partName = m[0];
        } else if(currentVideoData.segments.length>1) partName = `Parte ${i+1}`;
        if(!partsMap[partName]) partsMap[partName] = [];
        partsMap[partName].push(seg);
    });

    Object.keys(partsMap).forEach(partName=>{
        const partEl = document.createElement('div'); partEl.className='part';
        const partTitle = document.createElement('div'); partTitle.className='part-title'; partTitle.textContent=partName;
        partEl.appendChild(partTitle);

        partsMap[partName].forEach((seg,index)=>{
            const segEl = document.createElement('div'); segEl.className='segment';
            const segHeader = document.createElement('div'); segHeader.className='segment-header';
            const segTitle = document.createElement('div'); segTitle.className='segment-title'; segTitle.textContent=seg.title||`Segmento ${index+1}`;
            const segTimes = document.createElement('div'); segTimes.className='segment-times'; segTimes.textContent=`${seg.start} ‚Äì ${seg.end}`;
            segHeader.appendChild(segTitle); segHeader.appendChild(segTimes);

            const segDetails = document.createElement('div'); segDetails.className='segment-details';

            if(seg.transcription){
                const trDiv = document.createElement('div'); trDiv.className='transcription';
                let text = seg.transcription;
                
                // Substituir palavras por links
                text = makeTranscriptLinks(text);

// Depois aplica os links do dicion√°rio
Object.keys(linksMap).forEach(word => {
    const regex = new RegExp(`\\b${word}\\b`, 'g');
    text = text.replace(regex, `<a href="${linksMap[word]}" target="_blank" class="dict-link">${word}</a>`);
});

                trDiv.innerHTML = text;  // importante: innerHTML para renderizar <a>
                segDetails.appendChild(trDiv);
            }

            const playBtn = document.createElement('button'); playBtn.className='play-segment-btn'; playBtn.textContent='‚ñ∂Ô∏è Tocar este segmento';
            playBtn.addEventListener('click',()=>playSegment(currentVideoData.videoId,seg));
            segDetails.appendChild(playBtn);

            segHeader.addEventListener('click',()=>segDetails.classList.toggle('open'));
            segEl.appendChild(segHeader); segEl.appendChild(segDetails);
            partEl.appendChild(segEl);
        });
        partsContainer.appendChild(partEl);
    });
}



// YouTube Player
function loadYouTubePlayer(videoId){
    currentVideoId=videoId;
    if(!player){ player=new YT.Player('player',{ height:'360', width:'640', videoId:videoId, playerVars:{playsinline:1,modestbranding:1,rel:0}, events:{onReady:onPlayerReady,onStateChange:onPlayerStateChange} }); }
    else{ player.loadVideoById(videoId); player.stopVideo();}
    pauseBtn.disabled=false; stopBtn.disabled=false;
}
function onPlayerReady(e){ updateStatus('Pronto'); }
function onPlayerStateChange(e){ if(e.data==YT.PlayerState.PLAYING) updateStatus('Tocando'); else if(e.data==YT.PlayerState.PAUSED) updateStatus('Pausado'); else if(e.data==YT.PlayerState.ENDED){ updateStatus('Finalizado'); clearInterval(checkInterval); currentSegment=null; }}
function playSegment(videoId,seg){ if(!player) return; if(videoId!==currentVideoId){ loadYouTubePlayer(videoId); const check=setInterval(()=>{ if(player && player.getCurrentTime){ clearInterval(check); actuallyPlaySegment(seg); } },100); } else actuallyPlaySegment(seg);}
function actuallyPlaySegment(seg){ const start=toSeconds(seg.start), end=toSeconds(seg.end); player.seekTo(start,true); player.playVideo(); currentSegment={start,end,title:seg.title}; updateStatus(`Tocando: ${seg.title}`); clearInterval(checkInterval); checkInterval=setInterval(()=>{ if(player.getCurrentTime()>=currentSegment.end){ player.pauseVideo(); updateStatus(`Segmento conclu√≠do: ${seg.title}`); clearInterval(checkInterval); currentSegment=null;}},300);}
pauseBtn.addEventListener('click',()=>{ if(player) player.pauseVideo(); });
stopBtn.addEventListener('click',()=>{ if(player){ player.stopVideo(); updateStatus('Parado'); clearInterval(checkInterval); currentSegment=null; } });

// Bot√£o flutuante para link
document.addEventListener('selectionchange',()=>{
    const sel=document.getSelection();
    if(sel && sel.toString().trim()!==''){ selectedWord=sel.toString().trim(); const rect=sel.getRangeAt(0).getBoundingClientRect();
        linkBtn.style.top=(rect.top+window.scrollY-40)+'px'; linkBtn.style.left=(rect.left+window.scrollX)+'px'; linkBtn.style.display='block';
    } else { linkBtn.style.display='none'; selectedWord=''; }
});
linkBtn.addEventListener('click',()=>{ wordInputLink.value=selectedWord; urlInput.value=''; linkModal.style.display='block'; modalOverlay.style.display='block'; });
modalOverlay.addEventListener('click',()=>{ linkModal.style.display='none'; modalOverlay.style.display='none'; });
cancelLinkBtn.addEventListener('click',()=>{ linkModal.style.display='none'; modalOverlay.style.display='none'; });
saveLinkBtn.addEventListener('click',async ()=>{
    const word=wordInputLink.value.trim(); const url=urlInput.value.trim();
    if(!word || !url){ alert('Preencha todos os campos'); return; }
    try{ await db.collection('links').doc(word.toLowerCase()).set({palavra:word,link:url,dataCriacao:firebase.firestore.FieldValue.serverTimestamp()});
        alert('Link salvo!'); linkModal.style.display='none'; modalOverlay.style.display='none';
    }catch(e){ alert('Erro ao salvar link'); console.error(e);}
});

// Event listeners canais e v√≠deos
channelSelect.addEventListener('change',()=>{ if(channelSelect.value) loadVideosFromChannel(channelSelect.value); else { videoSelect.innerHTML='<option value="">Selecione um v√≠deo</option>'; videoSelect.disabled=true; loadBtn.disabled=true;} });
videoSelect.addEventListener('change',()=>{ loadBtn.disabled=!videoSelect.value; });
loadBtn.addEventListener('click',()=>{ if(channelSelect.value && videoSelect.value) loadVideoData(channelSelect.value,videoSelect.value); });

// YouTube API
const tag=document.createElement('script'); tag.src="https://www.youtube.com/iframe_api"; document.body.appendChild(tag);
window.onYouTubeIframeAPIReady=()=>console.log("YouTube API pronta.");

// Inicializar
loadChannels();
document.getElementById('cadastrarVideoBtn').addEventListener('click', () => {
    window.location.href = 'cadastrar-video.html'; // coloque o nome da sua p√°gina de cadastro
});
</script>
</body>
</html>
