<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mini Aula de Francês</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #ff9800;
            --secondary: #e1f5fe;
            --text: #333;
            --light: #fff;
            --shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --radius: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary), var(--secondary));
            color: var(--text);
            min-height: 100vh;
            padding-bottom: 2rem;
        }
        
        header {
            background-color: var(--light);
            box-shadow: var(--shadow);
            padding: 1rem 2rem;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 1rem;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .logo h1 {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .logo i {
            font-size: 2rem;
            color: var(--primary);
        }
        
        nav ul {
            display: flex;
            list-style: none;
            gap: 1.5rem;
        }
        
        nav a {
            text-decoration: none;
            color: var(--text);
            font-weight: 500;
            padding: 0.5rem 1rem;
            border-radius: var(--radius);
            transition: all 0.3s ease;
        }
        
        nav a:hover, nav a.active {
            background-color: var(--primary);
            color: var(--light);
        }
        
        .aula-container {
            background-color: var(--light);
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            padding: 2rem;
            margin-top: 2rem;
        }
        
        .aula-header {
            text-align: center;
            margin-bottom: 2rem;
            padding-bottom: 1rem;
            border-bottom: 2px solid var(--primary);
        }
        
        .aula-titulo {
            color: var(--primary);
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }
        
        .aula-descricao {
            font-size: 1.1rem;
            color: #666;
            margin-bottom: 1rem;
        }
        
        .aula-nivel {
            display: inline-block;
            background-color: var(--primary);
            color: var(--light);
            padding: 0.3rem 1rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .correcao-item {
            background-color: #f9f9f9;
            border-radius: var(--radius);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-left: 4px solid var(--primary);
        }
        
        .frase-container {
            display: flex;
            align-items: center;
            gap: 1rem;
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: var(--secondary);
            border-radius: var(--radius);
        }
        
        .frase-frances {
            font-size: 1.2rem;
            font-weight: 600;
            flex: 1;
        }
        
        .audio-icon {
            cursor: pointer;
            color: var(--primary);
            font-size: 1.5rem;
            transition: all 0.3s ease;
            background: none;
            border: none;
            padding: 0.5rem;
        }
        
        .audio-icon:hover {
            transform: scale(1.2);
            color: #e68900;
        }
        
        .audio-icon.playing {
            color: #4caf50;
            animation: pulse 1s infinite;
        }
        
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .frase-traducao {
            color: #666;
            font-style: italic;
            margin-bottom: 1rem;
            padding-left: 1rem;
            border-left: 3px solid #ddd;
        }
        
        .explicacao {
            background-color: #e8f5e9;
            padding: 1rem;
            border-radius: var(--radius);
            margin-bottom: 1rem;
        }
        
        .erro-correcao {
            display: flex;
            gap: 2rem;
            margin-bottom: 1rem;
        }
        
        .erro-box, .correcao-box {
            flex: 1;
            padding: 1rem;
            border-radius: var(--radius);
        }
        
        .erro-box {
            background-color: #ffebee;
            border: 1px solid #ffcdd2;
        }
        
        .correcao-box {
            background-color: #e8f5e9;
            border: 1px solid #c8e6c9;
        }
        
        .detalhes-erro {
            margin-top: 1rem;
            padding: 1rem;
            background-color: #fff3e0;
            border-radius: var(--radius);
        }
        
        .erro-item {
            margin-bottom: 0.5rem;
            padding: 0.5rem;
            background-color: #fff;
            border-radius: var(--radius);
        }
        
        .regra-gramatical {
            background-color: #e3f2fd;
            padding: 1.5rem;
            border-radius: var(--radius);
            margin: 2rem 0;
        }
        
        .exercicios {
            background-color: #f3e5f5;
            padding: 1.5rem;
            border-radius: var(--radius);
            margin: 2rem 0;
        }
        
        .exercicio-item {
            margin-bottom: 1rem;
            padding: 1rem;
            background-color: #fff;
            border-radius: var(--radius);
        }
        
        .vocabulario {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }
        
        .vocabulario-categoria {
            background-color: #f5f5f5;
            padding: 1rem;
            border-radius: var(--radius);
        }
        
        .palavra-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            border-bottom: 1px solid #eee;
        }
        
        .btn {
            display: inline-block;
            background-color: var(--primary);
            color: var(--light);
            padding: 0.8rem 1.5rem;
            border-radius: var(--radius);
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            border: none;
            cursor: pointer;
        }
        
        .btn:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow);
        }
        
        .loading {
            text-align: center;
            padding: 3rem;
            font-size: 1.2rem;
            color: var(--primary);
        }
        
        .error-message {
            text-align: center;
            padding: 3rem;
            background-color: #ffebee;
            color: #c62828;
            border-radius: var(--radius);
            margin: 2rem 0;
        }
        
        .tags-container {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin: 1rem 0;
        }
        
        .tag {
            background-color: var(--primary);
            color: var(--light);
            padding: 0.3rem 0.8rem;
            border-radius: 15px;
            font-size: 0.8rem;
        }
        
        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                gap: 1rem;
            }
            
            nav ul {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .erro-correcao {
                flex-direction: column;
                gap: 1rem;
            }
            
            .frase-container {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <i class="fas fa-language"></i>
                    <h1>Francês Interativo</h1>
                </div>
                <nav>
                    <ul>
                        <li><a href="index.html">Início</a></li>
                        <li><a href="admin.html">Administração</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>
    
    <main class="container">
        <div id="loading" class="loading">
            <i class="fas fa-spinner fa-spin"></i>
            <p>Carregando mini aula...</p>
        </div>
        
        <div id="aula-content" class="aula-container" style="display: none;">
            <!-- Conteúdo da aula será carregado aqui dinamicamente -->
        </div>
        
        <div id="error-message" class="error-message" style="display: none;">
            <!-- Mensagens de erro serão exibidas aqui -->
        </div>
    </main>
    
    <footer>
        <div class="container">
            <p>Sistema de Mini Aulas Interativas em Francês &copy; 2023</p>
        </div>
    </footer>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    
    <script>
        // Configuração do Firebase - MESMA CONFIGURAÇÃO DO ADMIN
        const firebaseConfig = {
            apiKey: "AIzaSyDDGUikGRoJoVu3g0tSenKtZHffflApUWQ",
            authDomain: "agenda-diaria-6c1ac.firebaseapp.com",
            projectId: "agenda-diaria-6c1ac",
            storageBucket: "agenda-diaria-6c1ac.firebasestorage.app",
            messagingSenderId: "38282868914",
            appId: "1:38282868914:web:a8332ed3fe258a41af71ab",
            measurementId: "G-3B5J0MLJ7R"
        };

        // Inicializar Firebase
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (error) {
            console.log('Firebase já inicializado');
        }
        
        const db = firebase.firestore();

        // Sistema de síntese de voz
        let synth = window.speechSynthesis;
        let currentUtterance = null;

        // Função para obter parâmetro da URL
        function getUrlParameter(name) {
            const urlParams = new URLSearchParams(window.location.search);
            return urlParams.get(name);
        }

        // Função para falar texto em francês
        function falarTexto(texto) {
            if (currentUtterance) {
                synth.cancel();
            }

            currentUtterance = new SpeechSynthesisUtterance(texto);
            currentUtterance.lang = 'fr-FR';
            currentUtterance.rate = 0.9;
            currentUtterance.pitch = 1;
            currentUtterance.volume = 1;

            currentUtterance.onend = function() {
                document.querySelectorAll('.audio-icon.playing').forEach(icon => {
                    icon.classList.remove('playing');
                });
            };

            currentUtterance.onerror = function(event) {
                console.error('Erro na síntese de voz:', event);
                document.querySelectorAll('.audio-icon.playing').forEach(icon => {
                    icon.classList.remove('playing');
                });
            };

            synth.speak(currentUtterance);
        }

        // Função para carregar a aula do REPOSITÓRIO
        async function carregarAula() {
            const docId = getUrlParameter('id');
            const titulo = getUrlParameter('titulo');
            
            console.log('Tentando carregar aula com:', { docId, titulo });
            
            if (!docId && !titulo) {
                mostrarErro('Parâmetro não encontrado na URL. Use ?id=ID_DO_DOCUMENTO ou ?titulo=TITULO_DA_AULA');
                return;
            }

            try {
                let docRef;
                
                if (docId) {
                    // Buscar por ID direto na coleção "repositorio"
                    docRef = db.collection('repositorio').doc(docId);
                    console.log('Buscando documento por ID:', docId);
                } else if (titulo) {
                    // Buscar por título
                    const snapshot = await db.collection('repositorio')
                        .where('titulo', '==', decodeURIComponent(titulo))
                        .limit(1)
                        .get();
                    
                    if (!snapshot.empty) {
                        docRef = snapshot.docs[0].ref;
                        console.log('Documento encontrado por título:', titulo);
                    } else {
                        throw new Error('Nenhum documento encontrado com este título');
                    }
                }

                const doc = await docRef.get();
                
                if (!doc.exists) {
                    throw new Error('Documento não encontrado no repositório');
                }

                const conteudo = doc.data();
                console.log('Conteúdo carregado:', conteudo);
                
                exibirAula(conteudo, doc.id);
                
            } catch (error) {
                console.error('Erro detalhado ao carregar aula:', error);
                mostrarErro(`Erro ao carregar a aula: ${error.message}`);
            }
        }

        // Função para exibir a aula
        function exibirAula(conteudo, docId) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('aula-content').style.display = 'block';
            
            // Atualizar título da página
            document.title = `${conteudo.titulo} - Francês Interativo`;
            
            let html = `
                <div class="aula-header">
                    <h1 class="aula-titulo">${conteudo.titulo || 'Sem título'}</h1>
                    <p class="aula-descricao">${conteudo.descricao || ''}</p>
                    ${conteudo.nivel ? `<span class="aula-nivel">${conteudo.nivel}</span>` : ''}
                    
                    ${conteudo.ementa_tags ? `
                        <div class="tags-container">
                            ${conteudo.ementa_tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 1rem; font-size: 0.9rem; color: #666;">
                        ID do documento: ${docId}
                    </div>
                </div>
            `;

            // Adicionar correções
            let correcaoCount = 0;
            for (const key in conteudo) {
                if (key.startsWith('correcao_')) {
                    const correcao = conteudo[key];
                    html += criarHtmlCorrecao(correcao);
                    correcaoCount++;
                }
            }

            // Adicionar explicação gramatical
            if (conteudo.explicacao_gramatical) {
                html += criarHtmlExplicacaoGramatical(conteudo.explicacao_gramatical);
            }

            // Adicionar exercícios
            if (conteudo.exercicios_praticos) {
                html += criarHtmlExercicios(conteudo.exercicios_praticos);
            }

            // Adicionar vocabulário
            if (conteudo.vocabulario_relacionado) {
                html += criarHtmlVocabulario(conteudo.vocabulario_relacionado);
            }

            // Mensagem se não houver correções
            if (correcaoCount === 0) {
                html += `
                    <div class="correcao-item">
                        <p>Nenhuma correção encontrada neste documento.</p>
                        <p>Verifique se o documento contém campos que começam com "correcao_".</p>
                    </div>
                `;
            }

            document.getElementById('aula-content').innerHTML = html;
            
            // Adicionar event listeners para os ícones de áudio
            document.querySelectorAll('.audio-icon').forEach(icon => {
                icon.addEventListener('click', function() {
                    const texto = this.getAttribute('data-texto');
                    if (texto) {
                        this.classList.add('playing');
                        falarTexto(texto);
                    }
                });
            });
        }

        // Função para criar HTML de uma correção
        function criarHtmlCorrecao(correcao) {
            return `
                <div class="correcao-item">
                    <div class="frase-container">
                        <div class="frase-frances">${correcao.frase || 'Frase não disponível'}</div>
                        ${correcao.frase ? `
                            <button class="audio-icon" data-texto="${correcao.frase}">
                                <i class="fas fa-volume-up"></i>
                            </button>
                        ` : ''}
                    </div>
                    ${correcao.traducao ? `
                        <div class="frase-traducao">${correcao.traducao}</div>
                    ` : ''}
                    
                    ${correcao.explicacao ? `
                        <div class="explicacao">
                            <strong>Explicação:</strong> ${correcao.explicacao}
                        </div>
                    ` : ''}
                    
                    ${correcao.erro_original ? `
                        <div class="erro-correcao">
                            <div class="erro-box">
                                <strong>❌ Sua frase:</strong><br>
                                ${correcao.erro_original}
                            </div>
                            <div class="correcao-box">
                                <strong>✅ Correção:</strong><br>
                                ${correcao.frase || 'Não disponível'}
                            </div>
                        </div>
                    ` : ''}
                    
                    ${correcao.explicacao_detalhada && correcao.explicacao_detalhada.erros ? `
                        <div class="detalhes-erro">
                            <h4>Detalhes dos erros:</h4>
                            ${Object.values(correcao.explicacao_detalhada.erros).map(erro => `
                                <div class="erro-item">
                                    <strong>${erro.seu_texto || ''} → ${erro.correto || ''}</strong><br>
                                    ${erro.explicacao || ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${correcao.frases_relacionadas ? `
                        <div class="frases-relacionadas">
                            <h4>Frases relacionadas:</h4>
                            ${correcao.frases_relacionadas.map(frase => `
                                <div class="frase-container">
                                    <div class="frase-frances">${frase.frase}</div>
                                    <button class="audio-icon" data-texto="${frase.frase}">
                                        <i class="fas fa-volume-up"></i>
                                    </button>
                                </div>
                                <div class="frase-traducao">${frase.traducao}</div>
                                ${frase.explicacao ? `<small>${frase.explicacao}</small>` : ''}
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Função para criar HTML da explicação gramatical
        function criarHtmlExplicacaoGramatical(explicacao) {
            return `
                <div class="regra-gramatical">
                    <h2>${explicacao.titulo || 'Regras Gramaticais'}</h2>
                    ${explicacao.conceito ? `<p><strong>Conceito:</strong> ${explicacao.conceito}</p>` : ''}
                    
                    ${explicacao.regras ? `
                        <div class="regras-lista">
                            ${explicacao.regras.map(regra => `
                                <div class="regra-item" style="margin-bottom: 1.5rem; padding: 1rem; background: white; border-radius: var(--radius);">
                                    <h4>${regra.demonstrativo || 'Regra'}</h4>
                                    ${regra.uso ? `<p><strong>Uso:</strong> ${regra.uso}</p>` : ''}
                                    ${regra.exemplos ? `
                                        <ul>
                                            ${regra.exemplos.map(exemplo => `<li>${exemplo}</li>`).join('')}
                                        </ul>
                                    ` : ''}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    ${explicacao.dicas ? `
                        <div class="dicas">
                            <h4>Dicas importantes:</h4>
                            <ul>
                                ${explicacao.dicas.map(dica => `<li>${dica}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Função para criar HTML dos exercícios
        function criarHtmlExercicios(exercicios) {
            return `
                <div class="exercicios">
                    <h2>${exercicios.titulo || 'Exercícios'}</h2>
                    ${exercicios.instrucoes ? `<p><strong>Instruções:</strong> ${exercicios.instrucoes}</p>` : ''}
                    
                    ${exercicios.exercicios ? `
                        <div class="exercicios-lista">
                            ${exercicios.exercicios.map((exercicio, index) => `
                                <div class="exercicio-item">
                                    <p><strong>Exercício ${index + 1}:</strong> ${exercicio.frase || ''}</p>
                                    <button onclick="mostrarResposta(${index})" class="btn">Ver Resposta</button>
                                    <div id="resposta-${index}" style="display: none; margin-top: 0.5rem;">
                                        <strong>Resposta:</strong> ${exercicio.resposta_correta || ''}<br>
                                        ${exercicio.explicacao ? `<em>${exercicio.explicacao}</em>` : ''}
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                </div>
            `;
        }

        // Função para criar HTML do vocabulário
        function criarHtmlVocabulario(vocabulario) {
            return `
                <div class="vocabulario-section">
                    <h2>Vocabulário Relacionado</h2>
                    <div class="vocabulario">
                        ${Object.entries(vocabulario).map(([categoria, palavras]) => `
                            <div class="vocabulario-categoria">
                                <h4>${categoria.replace(/_/g, ' ').toUpperCase()}</h4>
                                ${palavras.map(palavra => `
                                    <div class="palavra-item">
                                        <div>
                                            <strong>${palavra.palavra || ''}</strong><br>
                                            <small>${palavra.traducao || ''}</small>
                                        </div>
                                        ${palavra.palavra ? `
                                            <button class="audio-icon" data-texto="${palavra.palavra}" title="Ouvir pronúncia">
                                                <i class="fas fa-volume-up"></i>
                                            </button>
                                        ` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        }

        // Função para mostrar resposta dos exercícios
        function mostrarResposta(index) {
            const resposta = document.getElementById(`resposta-${index}`);
            if (resposta) {
                resposta.style.display = resposta.style.display === 'none' ? 'block' : 'none';
            }
        }

        // Função para mostrar erro
        function mostrarErro(mensagem) {
            document.getElementById('loading').style.display = 'none';
            document.getElementById('error-message').style.display = 'block';
            document.getElementById('error-message').innerHTML = `
                <h3>Erro ao carregar a aula</h3>
                <p>${mensagem}</p>
                <p><strong>Dica:</strong> Verifique se o ID do documento está correto e se as regras do Firebase permitem leitura pública.</p>
                <a href="javascript:location.reload()" class="btn">Tentar Novamente</a>
            `;
        }

        // Carregar a aula quando a página carregar
        window.addEventListener('load', function() {
            console.log('Página carregada, iniciando carregamento da aula...');
            carregarAula();
        });
    </script>
</body>
</html>